<HTML lang="en-US">

<HEAD>  

  <meta charset="UTF-8">
  <meta name="description" content="Boxed Values in LispBM">
  <meta name="keywords" content="lisp, lispbm, boxed values, heap, memory representation, microcontroller lisp, embedded lisp, stm32, esp32, memory management">
  <meta name="author" content="Bo Joel Svensson">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- SEO Meta Tags -->

  <link rel="canonical" href="https://www.lispbm.com/pages/lispbm-boxed-values/index.html" />
  <meta name="robots" content="index, follow">

  <!-- Open Graph Meta Tags -->

  <meta property="og:title" content="Boxed Values">
  <meta property="og:description" content="Boxed Values in LispBM">
  <meta property="og:image" content="https://www.lispbm.com/images/lispbm_llama_small.png">
  <meta property="og:url" content="https://www.lispbm.com/pages/lispbm-boxed-values/index.html">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="LispBM">

  <!-- Twitter Card Meta Tags -->

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Boxed Values">
  <meta name="twitter:description" content="Boxed Values in LispBM">
  <meta name="twitter:image" content="https://www.lispbm.com/images/lispbm_llama_small.png">

  <link rel="apple-touch-icon" sizes="180x180" href="https://www.lispbm.com/ico/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://www.lispbm.com/ico/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://www.lispbm.com/ico/favicon-16x16.png">
  <link rel="shortcut icon" href="https://www.lispbm.com/ico/favicon.ico">
  <link rel="icon" type="image/vnd.microsoft.icon" href="https://www.lispbm.com/ico/favicon.ico">
  <link rel="icon" type="image/x-icon" href="https://www.lispbm.com/ico/favicon.ico">
  <link rel="icon" href="https://www.lispbm.com/ico/favicon.ico">
  <link rel="manifest" href="https://www.lispbm.com/ico/site.webmanifest">

  <link rel="stylesheet" href="../../styles.css">

</HEAD> 

<TITLE>Boxed Values</TITLE>

<BODY class="with-background">

<div class="container">
  <div class="banner"></div>

  <div class="nav-menu">
    <a href="https://www.lispbm.com/" class="back-link">← Back to LispBM Home</a>
  </div>

<!-- Content starts here --> 

<h1 id="boxed-values">Boxed Values</h1>
<p>LispBM can encode values of 4 different types into the
<code>car</code> or <code>cdr</code> of a cons-cell. How this works can
be found in the earler <a
href="../lispbm-current_status/index.html">walkthrough of lispBM</a>.
The 4 types that can be encoded are, <code>symbol</code>,
<code>character</code>, <code>integer</code> and
<code>unsigned integer</code>. All of these types are 28Bit.</p>
<p>To be able to express computations on 32Bit values,
<code>integer</code>, <code>unsigned integer</code> and
<code>float</code> as well as arrays, a set of <em>boxed</em> types were
introduced.</p>
<p>The boxed values, except arrays, are stored in cons cells but have an
extra level of indirection in the form of a typed pointer. Since the
lisp heap is small there are unused bits on the most significant side.
The 4 most significant bits are used to encode different typed pointers.
Currently the following kinds of typed pointers are in use:</p>
<pre><code>#define PTR_TYPE_CONS        0x10000000u
#define PTR_TYPE_BOXED_I     0x20000000u
#define PTR_TYPE_BOXED_U     0x30000000u
#define PTR_TYPE_BOXED_F     0x40000000u
#define PTR_TYPE_ARRAY       0xD0000000u</code></pre>
<p>As an example, a float value is encoded as a cons cell where all the
32Bits of the <code>car</code> are used for the floating point value.
The <code>cdr</code> of this cell contail a special symbol
<code>DEF_REPR_BOXED_F_TYPE</code>. The special symbols used in the
<code>cdr</code> position of boxed values are listed below.</p>
<pre><code>#define DEF_REPR_ARRAY_TYPE     0x20FFFF
#define DEF_REPR_BOXED_I_TYPE   0x21FFFF
#define DEF_REPR_BOXED_U_TYPE   0x22FFFF
#define DEF_REPR_BOXED_F_TYPE   0x23FFFF</code></pre>
<p>Only the <code>cdr</code> field of a cons cell hold a GC bit so there
is no problem in using all 32Bits of the <code>car</code> if only it can
be identified properly.</p>
<p>Arrays are a special case and not fully implemented yet. Currently
the only thing that is an array in lispBM is a text string. Most of the
plumbing is there for implementing arrays of any other lispBM value
type, it just needs to be hacked up. Arrays are encoded in a very
similar way to boxed values, just that instead of a 32Bit value in the
<code>car</code> slot there is an arbitrary pointer. The array storage
itself is allocated using <code>malloc</code>. When garbage collection
frees a cons cell with the special symbol
<code>DEF_REPR_ARRAY_TYPE</code>, it also calls <code>free</code> on the
pointer in the <code>car</code> position.</p>
<hr />
</div> <!-- Close container -->

<footer style="margin-top: 50px; padding: 20px; background: #f8f9fa; border-top: 1px solid #dee2e6; text-align: center;">
  <p>
    <a href="https://www.lispbm.com/" class="back-link">← Back to LispBM Home</a>
  </p>

  <p>
    Please contact me with questions, suggestions or feedback at blog
    (dot) joel (dot) svensson (at) gmail (dot) com or join the
    <a href="https://groups.google.com/g/svenssonjoelgithubio"> google group</a>. 
  </p>

  <p>&copy; Copyright 2020 Bo Joel Svensson</p>

  <p><small>This page was generated using <a href="https://pandoc.org/">Pandoc</a>.</small></p>
</footer>

</BODY>
</HTML>
